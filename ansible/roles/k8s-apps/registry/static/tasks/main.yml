- name: Create registry namespacef
  shell: kubectl get namespace registry --kubeconfig /etc/kubernetes/admin.conf || kubectl create namespace registry --kubeconfig /etc/kubernetes/admin.conf

- name: Create {{ registry_dir }} dirs
  file:
    path: "{{ registry_dir }}/{{ item }}"
    state: directory
  with_items:
    - data
    - config

# Create htpasswd
# Note: do not use ansible htpassword module
- name: Create htpasswd
  shell:
    cmd: docker run --rm --entrypoint htpasswd registry:{{ registry_version }} -Bbn {{ registry_user }} {{ registry_password }} > htpasswd
    chdir: "{{ registry_dir }}/config"

- name: Change htpasswd mode
  file:
    path: "{{ registry_dir }}/config/htpasswd"
    owner: root
    mode: 0600

- name: Copy registry.csr json
  copy:
    src: registry.csr.json
    dest: "{{ registry_dir }}/config/"

- name: Create certificates
  shell:
    cmd: >-
      /usr/local/bin/cfssl gencert
      -ca /etc/kubernetes/pki/ca.crt
      -ca-key /etc/kubernetes/pki/ca.key
      -cn registry
      -hostname localhost,127.0.0.1,{{ inventory_hostname }}
      registry.csr.json
      | /usr/local/bin/cfssljson -bare registry
    chdir: "{{ registry_dir }}/config"

- name: Rename certificate
  shell:
    cmd: "{{ item }}"
    chdir: "{{ registry_dir }}/config"
  with_items:
    - /bin/mv registry-key.pem registry.key
    - /bin/mv registry.pem registry.crt

- name: Install registry static pod manifest
  template:
    src: registry.yml.j2
    dest: /etc/kubernetes/manifests/registry.yml

- name: Allow firewall for registry
  firewalld:
    port: "{{ registry_port }}"
    permanent: yes
    state: enabled
    immediate: yes
  when: firewall_enabled
